# [0039. å¼•ç”¨å’Œä¸‹è½½ canvas å›¾åƒ](https://github.com/tnotesjs/TNotes.canvas/tree/main/notes/0039.%20%E5%BC%95%E7%94%A8%E5%92%8C%E4%B8%8B%E8%BD%BD%20canvas%20%E5%9B%BE%E5%83%8F)

<!-- region:toc -->

- [1. ğŸ¯ ç›®æ ‡](#1--ç›®æ ‡)
- [2. ğŸ«§ è¯„ä»·](#2--è¯„ä»·)
- [3. ğŸ’» demos.1 - å®ç° canvas å›¾åƒçš„ä¸€é”®ä¸‹è½½](#3--demos1---å®ç°-canvas-å›¾åƒçš„ä¸€é”®ä¸‹è½½)
- [4. ğŸ¤” data url æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå°†å…¶èµ‹å€¼ç»™ a å…ƒç´ çš„ href å±æ€§ä¹‹åå°±èƒ½å®ç°ä¸€é”®ä¸‹è½½äº†å‘¢ï¼Ÿ](#4--data-url-æ˜¯ä»€ä¹ˆä¸ºä»€ä¹ˆå°†å…¶èµ‹å€¼ç»™-a-å…ƒç´ çš„-href-å±æ€§ä¹‹åå°±èƒ½å®ç°ä¸€é”®ä¸‹è½½äº†å‘¢)
  - [4.1. Data URL ç®€ä»‹](#41-data-url-ç®€ä»‹)
  - [4.2. ä¸ºä»€ä¹ˆèµ‹å€¼ç»™ a å…ƒç´ çš„ href èƒ½å®ç°ä¸‹è½½ï¼Ÿ](#42-ä¸ºä»€ä¹ˆèµ‹å€¼ç»™-a-å…ƒç´ çš„-href-èƒ½å®ç°ä¸‹è½½)
- [5. ğŸ”— References](#5--references)

<!-- endregion:toc -->

## 1. ğŸ¯ ç›®æ ‡

- çŸ¥é“å¦‚ä½•å¼•ç”¨å·²æœ‰çš„ canvas å›¾åƒ
- çŸ¥é“å¦‚ä½•å®ç°ä¸€é”®ä¸‹è½½ canvas å›¾åƒ

## 2. ğŸ«§ è¯„ä»·

- canvas æœ¬èº«ä¹Ÿæ˜¯å›¾åƒï¼Œå¯ä»¥è¢«ä¸‹è½½ï¼Œå¯ä»¥è¢«å¼•ç”¨ã€‚
- ä½ å¯ä»¥å°† canvas å°±çœ‹åšæ˜¯ä¸€ä¸ªç™½è‰²çš„ç”»å¸ƒï¼Œç„¶åä½ å¯ä»¥é€šè¿‡ canvas æä¾›çš„ä¸€äº› API åœ¨è¿™ä¸ªç”»å¸ƒä¸Šç»˜å›¾ï¼Œç»˜å›¾å®Œæ¯•åä½ å¯ä»¥åœ¨åˆ«çš„ canvas ä¸­å¤ç”¨è¿™å¼ å›¾ç‰‡ï¼Œå¯ä»¥å¯¹å®ƒè¿›è¡ŒäºŒæ¬¡ç¼–è¾‘ï¼Œä¹Ÿå¯ä»¥ä¸‹è½½è¿™å¼ å›¾ç‰‡ã€‚
- æ ¸å¿ƒ APIï¼š
  - å¼•ç”¨å·²æœ‰çš„ canvasï¼š`ctx.drawImage(image, x, y, width, height)`ï¼Œimage å°±æ˜¯è¢«å¼•ç”¨çš„ canvasã€‚
  - ä¸€é”®ä¸‹è½½ canvasï¼š`canvas.toDataURL(type, encoderOptions)`ï¼Œç”¨äºå°† Canvas çš„å†…å®¹è½¬æ¢ä¸ºæ•°æ® URLï¼ˆä¹Ÿç§°ä¸º Data URIï¼‰ï¼Œå°†å…¶èµ‹å€¼ç»™ a å…ƒç´ çš„ href å±æ€§ï¼Œä»è€Œå®ç°ä¸€é”®ä¸‹è½½ã€‚
- å¦‚æœä¸æ¸…æ¥š Data URL æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥çœ‹çœ‹ç¬”è®°ä¸­è®°å½•çš„ AI å…³äº Data URL çš„å›å¤ã€‚

## 3. ğŸ’» demos.1 - å®ç° canvas å›¾åƒçš„ä¸€é”®ä¸‹è½½

- å›¾ç‰‡ç´ æï¼š

::: swiper

![we](./demos/1/we.png)

:::

::: code-group

<<< ./demos/1/1.js {70-71,106}

<<< ./demos/1/1.html {}

:::

- æœ€ç»ˆæ•ˆæœï¼š
  - ![img](https://cdn.jsdelivr.net/gh/Tdahuyou/imgs@main/2024-10-04-11-56-45.png)
- æ³¨æ„ï¼š
  - å¦‚æœè¦ä¸‹è½½ canvas3ï¼Œéœ€è¦ä»¥ live server çš„å½¢å¼æ¥å¯åŠ¨ï¼Œå¦åˆ™ä¼šæŠ¥è·¨åŸŸé”™è¯¯ã€‚
  - å›¾ç‰‡è®¿é—®è·¨åŸŸçš„é—®é¢˜åœ¨ [0036. ctx.getImageDataã€ctx.putImageData][1] ç¬”è®°ä¸­ä¹Ÿæœ‰æåŠï¼Œéƒ½æ˜¯ä¸€ä¸ªé“ç† â€”â€” è¯»å–å›¾åƒæ•°æ®æ˜¯æ•æ„Ÿæ“ä½œï¼Œå½“æˆ‘ä»¬ä»¥ç›´æ¥ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€æœ¬åœ°æ–‡ä»¶ï¼ˆ`file://`ï¼‰æ–¹å¼æ‰“å¼€é¡µé¢æ—¶ï¼Œè®¿é—®å›¾ç‰‡æ•°æ®å°±ä¼šæŠ›å‡º `cross-origin` è·¨åŸŸé”™è¯¯ã€‚

## 4. ğŸ¤” data url æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå°†å…¶èµ‹å€¼ç»™ a å…ƒç´ çš„ href å±æ€§ä¹‹åå°±èƒ½å®ç°ä¸€é”®ä¸‹è½½äº†å‘¢ï¼Ÿ

### 4.1. Data URL ç®€ä»‹

- `Data URL`
  - Data URLï¼ˆæ•°æ®ç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼‰æ˜¯ä¸€ç§å…è®¸æˆ‘ä»¬åœ¨ URL ä¸­ç›´æ¥åµŒå…¥æ•°æ®çš„ URI æ–¹æ¡ˆã€‚å®ƒç”± RFC 2397 å®šä¹‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```txt
data:[<mediatype>][;base64],<data>
```

- Data URL ç»„æˆéƒ¨åˆ†ï¼š
  1. **`data:`** - åè®®æ ‡è¯†ç¬¦
  2. **`[<mediatype>]`** - å¯é€‰çš„åª’ä½“ç±»å‹ï¼ˆå¦‚ `image/png`ã€`text/html` ç­‰ï¼‰
  3. **`;base64`** - å¯é€‰çš„ç¼–ç æ–¹å¼ï¼ˆbase64 ç¼–ç ï¼‰
  4. **`<data>`** - å®é™…çš„æ•°æ®å†…å®¹
- ç¤ºä¾‹ï¼š

```javascript
// PNG å›¾åƒçš„ Data URL
'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA...'

// çº¯æ–‡æœ¬çš„ Data URL
'data:text/plain;charset=utf-8,Hello%20World'

// HTML å†…å®¹çš„ Data URL
'data:text/html,<html><body><h1>Hello</h1></body></html>'
```

### 4.2. ä¸ºä»€ä¹ˆèµ‹å€¼ç»™ a å…ƒç´ çš„ href èƒ½å®ç°ä¸‹è½½ï¼Ÿ

- æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
  - å½“æµè§ˆå™¨é‡åˆ° Data URL æ—¶ï¼Œä¼šè‡ªåŠ¨è§£æå…¶ä¸­çš„æ•°æ®å¹¶è¯†åˆ«å…¶ç±»å‹ã€‚
  - å¯¹äºå›¾åƒç­‰å¯ä¸‹è½½å†…å®¹ï¼Œæµè§ˆå™¨ä¼šå°†å…¶è§†ä¸ºæœ‰æ•ˆçš„èµ„æºé“¾æ¥ã€‚
- HTML5 ä¸‹è½½å±æ€§

```html
<a href="data:image/png;base64,..." download="filename.png">ä¸‹è½½å›¾ç‰‡</a>
```

- å…³é”®åœ¨äº `download` å±æ€§ï¼š
  - å‘Šè¯‰æµè§ˆå™¨è¿™æ˜¯ä¸€ä¸ªä¸‹è½½é“¾æ¥ï¼Œè€Œä¸æ˜¯å¯¼èˆªé“¾æ¥
  - æŒ‡å®šä¸‹è½½æ–‡ä»¶çš„é»˜è®¤æ–‡ä»¶å
  - æµè§ˆå™¨ä¼šè§¦å‘ä¸‹è½½å¯¹è¯æ¡†è€Œä¸æ˜¯ç›´æ¥æ˜¾ç¤ºå†…å®¹
- åœ¨ `demos.1` ä¸­ï¼š

```javascript
function createDownloadHandler(canvas, filename) {
  return function () {
    const url = canvas.toDataURL() // ç”Ÿæˆ Data URL
    const a = document.createElement('a')
    a.href = url // è®¾ç½®é“¾æ¥åœ°å€
    a.download = filename // æŒ‡å®šä¸‹è½½æ–‡ä»¶å
    a.style.display = 'none'
    document.body.appendChild(a)
    a.click() // æ¨¡æ‹Ÿç‚¹å‡»è§¦å‘ä¸‹è½½
    document.body.removeChild(a)
  }
}
```

- å·¥ä½œæµç¨‹ï¼š
  1. `canvas.toDataURL()` ç”ŸæˆåŒ…å«å›¾åƒæ•°æ®çš„ Data URL
  2. åˆ›å»ºä¸€ä¸ªéšè—çš„ `<a>` å…ƒç´ 
  3. å°† Data URL èµ‹å€¼ç»™ `a.href`
  4. è®¾ç½® `a.download` æŒ‡å®šæ–‡ä»¶å
  5. é€šè¿‡ `a.click()` è§¦å‘æµè§ˆå™¨çš„ä¸‹è½½è¡Œä¸º
  6. ä¸‹è½½å®Œæˆåç§»é™¤ä¸´æ—¶çš„ `<a>` å…ƒç´ 
- è¿™ç§æ–¹å¼çš„ä¼˜åŠ¿æ˜¯ç®€å•é«˜æ•ˆï¼Œä¸éœ€è¦æœåŠ¡å™¨å‚ä¸ï¼Œç›´æ¥åœ¨å®¢æˆ·ç«¯å®Œæˆå›¾åƒä¸‹è½½åŠŸèƒ½ã€‚

## 5. ğŸ”— References

- [0036. ctx.getImageDataã€ctx.putImageData][1]

[1]: /TNotes.canvas/notes/0036
